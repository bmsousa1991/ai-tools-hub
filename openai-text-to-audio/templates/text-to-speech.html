{% extends "base.html" %}

{% block title %}Text to Speech - AI Tools{% endblock %}

{% block extra_css %}
<style>
    textarea {
        resize: vertical;
        min-height: 300px;
        height: 300px;
        font-size: 1rem;
        line-height: 1.6;
        padding: 1rem;
    }

    .audio-history {
        margin-top: 2rem;
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
    }

    .audio-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .audio-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .audio-text {
        max-height: 100px;
        overflow-y: auto;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #4a5568;
    }

    .audio-meta {
        font-size: 0.8rem;
        color: #718096;
    }

    .progress {
        height: 0.5rem;
        margin-top: 1rem;
        display: none;
    }

    .status-message {
        margin-top: 1rem;
        display: none;
    }

    .delete-btn {
        color: #e53e3e;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .delete-btn:hover {
        color: #c53030;
    }

    .no-audio-message {
        text-align: center;
        color: #718096;
        padding: 2rem;
    }

    .language-badge, .voice-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        color: white;
        margin-right: 0.5rem;
    }

    .language-badge {
        background-color: #4a5568;
    }

    .voice-badge {
        background-color: #6366f1;
    }

    .language-select-container {
        display: none;
        transition: all 0.3s ease;
    }

    .language-select-container.show {
        display: block;
    }

    .form-check {
        margin-bottom: 1rem;
    }

    .audio-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }

    /* Add a subtle hint about text length */
    .text-hint {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 0.5rem;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12">
        <h1 class="text-center mb-4">Text to Speech Converter</h1>
        
        <form id="convertForm">
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" name="title" placeholder="Enter a title for your audio (optional)">
            </div>
            <div class="mb-3">
                <label for="text" class="form-label">Text</label>
                <textarea 
                    class="form-control"
                    placeholder="Enter your text here... You can paste long articles or large texts, they will be processed automatically."
                    name="text"
                    id="text"
                    required
                ></textarea>
                <div class="text-hint">
                    <i class="bi bi-info-circle"></i> You can paste large texts or articles - they will be automatically processed in chunks
                </div>
            </div>
            <div class="mb-3">
                <label for="voice" class="form-label">Voice</label>
                <select class="form-select" name="voice" id="voice" required>
                    {% for code, name in voices.items() %}
                    <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="needsTranslation" name="needs_translation">
                <label class="form-check-label" for="needsTranslation">
                    Translate text before converting to speech
                </label>
            </div>
            <div class="mb-3 language-select-container" id="languageContainer">
                <label for="language" class="form-label">Target Language</label>
                <select class="form-select" name="language" id="language">
                    {% for code, name in languages.items() %}
                    {% if code != 'en' %}
                    <option value="{{ code }}">{{ name }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-soundwave"></i> Convert to Speech
            </button>
        </form>

        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>

        <div class="alert status-message" role="alert"></div>

        <!-- Audio History Section -->
        <div class="audio-history">
            <h3 class="mb-4">
                <i class="bi bi-clock-history"></i> Recent Conversions
            </h3>
            
            {% if audio_files %}
                {% for audio in audio_files %}
                <div class="audio-item" data-filename="{{ audio.filename }}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="audio-title">{{ audio.title or 'Untitled' }}</div>
                            <div class="audio-text">
                                <span class="language-badge">{{ audio.language }}</span>
                                {% if audio.voice %}
                                <span class="voice-badge">{{ audio.voice }}</span>
                                {% endif %}
                                {{ audio.text }}
                            </div>
                            <audio controls class="w-100 mb-2">
                                <source src="{{ url_for('static', filename='audio/' + audio.filename) }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="audio-meta">
                                Created: {{ audio.timestamp.split('T')[0] }} {{ audio.timestamp.split('T')[1][:8] }}
                            </div>
                        </div>
                        <div class="ms-3">
                            <i class="bi bi-trash delete-btn" onclick="deleteAudio('{{ audio.filename }}')"></i>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-audio-message">
                    <i class="bi bi-music-note-list display-4 mb-3"></i>
                    <p>No audio files yet. Convert some text to get started!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const form = document.getElementById('convertForm');
    const progressBar = document.querySelector('.progress');
    const progressBarInner = document.querySelector('.progress-bar');
    const statusMessage = document.querySelector('.status-message');
    const needsTranslation = document.getElementById('needsTranslation');
    const languageContainer = document.getElementById('languageContainer');
    const languageSelect = document.getElementById('language');

    // Toggle language selector visibility
    needsTranslation.addEventListener('change', function() {
        languageContainer.classList.toggle('show', this.checked);
        languageSelect.required = this.checked;
    });

    function showStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = `alert status-message alert-${type}`;
        statusMessage.style.display = 'block';
    }

    function hideStatus() {
        statusMessage.style.display = 'none';
    }

    async function deleteAudio(filename) {
        if (!confirm('Are you sure you want to delete this audio?')) return;

        try {
            const response = await fetch(`/delete-audio/${filename}`, {
                method: 'POST'
            });

            if (response.ok) {
                const audioItem = document.querySelector(`[data-filename="${filename}"]`);
                audioItem.remove();
                showStatus('Audio deleted successfully', 'success');
                setTimeout(hideStatus, 3000);
            } else {
                throw new Error('Failed to delete audio');
            }
        } catch (err) {
            showStatus('Error deleting audio: ' + err.message, 'danger');
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = form.querySelector('button');
        button.disabled = true;
        progressBar.style.display = 'block';
        progressBarInner.style.width = '0%';
        hideStatus();

        try {
            const formData = new FormData(form);
            
            // If translation is not needed, don't send the language parameter
            if (!needsTranslation.checked) {
                formData.delete('language');
            }
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress > 90) clearInterval(progressInterval);
                progressBarInner.style.width = `${progress}%`;
            }, 500);

            showStatus('Converting text to speech...', 'info');

            const response = await fetch('/convert', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || 'Conversion failed');
            }

            const data = await response.json();
            
            clearInterval(progressInterval);
            progressBarInner.style.width = '100%';
            
            const audioHistory = document.querySelector('.audio-history');
            const noAudioMessage = document.querySelector('.no-audio-message');
            if (noAudioMessage) noAudioMessage.remove();

            const audioItem = document.createElement('div');
            audioItem.className = 'audio-item';
            audioItem.dataset.filename = data.filename;
            audioItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="audio-title">${data.title || 'Untitled'}</div>
                        <div class="audio-text">
                            <span class="language-badge">${data.language}</span>
                            <span class="voice-badge">${data.voice}</span>
                            ${data.text}
                        </div>
                        <audio controls class="w-100 mb-2">
                            <source src="${data.audio_url}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="audio-meta">
                            Created: ${data.timestamp.split('T')[0]} ${data.timestamp.split('T')[1].substring(0, 8)}
                        </div>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-trash delete-btn" onclick="deleteAudio('${data.filename}')"></i>
                    </div>
                </div>
            `;

            const firstItem = audioHistory.querySelector('.audio-item');
            if (firstItem) {
                audioHistory.insertBefore(audioItem, firstItem);
            } else {
                audioHistory.appendChild(audioItem);
            }

            showStatus('Conversion completed successfully!', 'success');
            form.reset();
            languageContainer.classList.remove('show');
        } catch (err) {
            showStatus(err.message, 'danger');
        } finally {
            button.disabled = false;
            setTimeout(() => {
                progressBar.style.display = 'none';
                hideStatus();
            }, 3000);
        }
    });
</script>
{% endblock %} 